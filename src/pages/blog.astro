---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets'; // Importa o componente de imagem otimizada

// CORREÇÃO: Usa getCollection em vez de Astro.glob para buscar os posts
const posts = (await getCollection('blog')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Mapeia os caminhos das imagens para importá-las dinamicamente
// Esta é a "mágica" para o Astro processar as imagens corretamente
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/blog/*.{jpeg,jpg,png,gif}');
---
<Layout title="Blog | ELOnARTE" description="Artigos e reflexões sobre arte, tecnologia e consciência.">
	<div class="container">
		<section>
			<h1>Blog</h1>
			<ul class="post-list">
				{posts.map(async (post) => {
					// CORREÇÃO: Verifica se a imagem do frontmatter existe no nosso mapa de imagens importadas
					if (!images[post.data.heroImage]) {
						throw new Error(`A imagem "${post.data.heroImage}" não foi encontrada na pasta /src/assets/blog/!`);
					}
					
					return (
						<li>
							<a href={`/blog/${post.slug}/`} class="post-link">
								<Image
									src={images[post.data.heroImage]()}
									alt=""
									width={300}
									height={150}
									class="post-image"
								/>
								<div class="post-text">
									<h2 class="post-title">{post.data.title}</h2>
									<p class="post-date">{post.data.pubDate.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
									<p class="post-description">{post.data.description}</p>
								</div>
							</a>
						</li>
					)
				})}
			</ul>
		</section>
	</div>
</Layout>

<style>
	.post-list {
		list-style: none;
		padding: 0;
		display: grid;
		gap: 2rem;
	}
	.post-link {
		display: block;
		background-color: var(--color-bg-light);
		border-radius: 8px;
		overflow: hidden;
		text-decoration: none;
		color: var(--color-text-primary);
		transition: transform 0.3s ease;
	}
	.post-link:hover {
		transform: translateY(-5px);
	}
	.post-image {
		width: 100%;
		height: auto;
		object-fit: cover;
	}
	.post-text {
		padding: 1.5rem;
	}
	.post-title {
		font-size: 1.5rem;
		margin-bottom: 0.5rem;
	}
	.post-date {
		color: var(--color-text-secondary);
		font-size: 0.9rem;
		margin-bottom: 1rem;
	}
</style>
